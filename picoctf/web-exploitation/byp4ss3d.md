# byp4ss3d picoMini by CMU-Africa

## Lab Overview
- **Platform**: picoCTF
- **Difficulty**: Medium
- **Vulnerability**: File upload vulnerability leading to remote code execution (RCE)
- **Date Solved**: 2025-10-17
- **Author**: Ammar Sabit

## Description
This site is vulnerable to remote code execution through improper blacklisting of potentially dangerous file extensions. This allows an attacker to upload and overwrite server configuration files, enabling the execution of arbitrary code.

## Steps to Reproduce

1. **Identify allowed file extensions**:
   - The client-side validation indicates that only PNG, JPG, and GIF files are permitted for upload.
   - Attempts to upload potentially dangerous files, such as PHP scripts, are blocked by server-side blacklisting.

2. **Identify the web server**:
   - Bypassing the extension check using null byte injection (e.g., `exploit.php%00.png`) allows the file to be uploaded successfully.
   - Accessing the uploaded file at `/images/exploit.php%00.png` results in a 404 error that leaks server details: "Not Found. The requested URL was not found on this server. Apache/2.4.62 (Debian) Server at amiable-citadel.picoCTF.net Port 52107."
   - This reveals the web server as Apache version 2.4.62 on Debian.

3. **Discover Apache configuration file**:
   - Apache supports `.htaccess` files to control server behavior for specific directories without modifying the main configuration.
   - Uploading a custom `.htaccess` file is accepted, allowing it to overwrite the existing configuration in the upload directory.

4. **Overwrite the configuration to execute images as PHP**:
   - The `.htaccess` file can be modified to instruct Apache to process specified file types as PHP.
   - Upload a `.htaccess` file containing the following directive:
     ```
     AddType application/x-httpd-php .png .jpg .gif
     ```
   - This configures the server to interpret PNG, JPG, and GIF files as PHP scripts.
   - Subsequent uploads of image files with embedded PHP code will now execute as PHP when accessed.

5. **Upload and execute PHP payload in an image file**:
   - Create a PHP payload file (e.g., `exploit.php`) with content such as `<?php system('ls'); ?>`.
   - Rename it to `exploit.png` (or modify an existing PNG via Burp Repeater) and upload it.
   - Navigate to `/images/exploit.png` to execute the payload, which lists files in the upload directory.
   - Escalate by navigating up the directory structure (e.g., `<?php system('cd ../../ && ls && pwd'); ?>`) to reveal `flag.txt` in `/var/www/`.
   - Read the flag with `<?php system('cat ../../flag.txt'); ?>`.
   - Retrieved flag: `picoCTF{s3rv3r_byp4ss_e46b22e5}`.
   - Submitting the flag solves the challenge.

## Impact
- Achieves full RCE on the server, allowing arbitrary file reads, deletions, data exfiltration, or further compromise (e.g., privilege escalation).

## Prevention
- Use strict whitelisting of allowed file types instead of blacklisting, to avoid overlooking dangerous extensions.
- Perform server-side validation of file contents (e.g., MIME type checking and content scanning) before storing uploads.
- Disable `.htaccess` overrides or restrict PHP execution in upload directories.